#!/usr/bin/env bash

rider_args=()
eap=false
project_path=

while [[ $# -gt 0 ]]; do
    key="$1"
    shift
    
    case "$key" in
        --eap)
            eap=true
            ;;
        -*|--*)
            rider_args+=("$key")
            ;;
        *)
            project_path="$key"
            ;;
    esac
done

if [ -z "$project_path" ]; then
    files=()
    while IFS=  read -r -d $'\0'; do
        files+=("$REPLY")
    done < <(find $(pwd) -type f -name "*.sln" -maxdepth 1 -print0)

    if [ -z "$files" ]; then
        echo "No solution file found" 1>&2
        exit 1
    elif [ ${#files[@]} -gt 1 ]; then
        if type fzf >/dev/null 2>&1; then
            echo "Multiple solution files found, select one"
            selected=$(ls -1 *.sln | fzf)
            project_path="$selected"
        else
            echo "Multiple solution files found, specify a single solution" 1>&2
            exit 1
        fi
    else
        project_path="$files"
    fi
fi

$eap && eap_str=" EAP"

rider_args+=("$project_path")

echo "Launching Rider${eap_str} for solution $project_path"

if [ "$(uname)" == "Darwin" ]; then
    if $eap; then
        if [ -e "/Applications/Rider EAP.app" ]; then
            open -a "/Applications/Rider EAP.app" --args "${rider_args[@]}"
            exit 0
        else
            echo "Could not find Rider EAP. Going to try non-EAP version."
        fi
    fi

    if [ -e "/Applications/Rider.app" ]; then
        open -a "/Applications/Rider.app" --args "${rider_args[@]}"
        exit 0
    elif [ -e "/Applications/Rider EAP.app" ]; then
        read -p "Could not find Rider. The EAP version is installed, press Y to use that, or any other key to cancel. " input
        if [ "$input" = "y" ] || [ "$input" = "Y" ]; then
            open -a "/Applications/Rider EAP.app" --args "${rider_args[@]}"
            exit 0
        fi
    else
        echo "Rider isn't installed" 1>&2
    fi
else
    echo "Not yet implemented for linux" 1>&2
fi

exit 1